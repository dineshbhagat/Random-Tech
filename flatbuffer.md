

- [Basics:](#basics)
- [IDL](#idl)
- [Install flatc and compile](#install-flatc-and-compile)
- [code](#code)
- [Convert Json to Binary File using Schema File](#convert-json-to-binary-file-using-schema-file)
- [Ref:](#ref)



------

Why you want to learn this?

What is flat buffer:

[http://google.github.io/flatbuffers/](http://google.github.io/flatbuffers/)

Then comes how.

------



#### Basics:

Schema —> Compiler —> Source Code file



- schema: Since here all data types are specified, strongly type checked, also no dynamic memory allocation, no type conversion or unpacking during load time, since before hand datatype known, 

- Compiler: flatc, various flags available to help, with this we can generate multilanguage files which we can include it in our source code and compile again.
- Source code file, include it in source code, to encode/decode serializable entities



------

#### IDL 

Article.fbs and Comment.fbs file:

```java
/// includes must come before declarations
include "Comment.fbs";

/// package declaration for generated java file
namespace com.dkb;

/// This is schema file for Article DTO
table Article {
  articleText:string;
  id:int;
  comments:[Comment];
}
root_type Article;
```

```java
namespace com.dkb;

table Comment {
  id:int;
  comment_str:string;
}
```

NOTE: on deciding schema, if you have String field and whose values is bounded, then it is best to describe as enum and use enum schema for this, rather than String,  This helps in reducing size significantly.



#### Install flatc and compile

- Using Homebrew: `brew install flatbuffers --HEAD`
- [SO](https://stackoverflow.com/q/24275803/2987755)

```sh
./flatc --gen-mutable --java fbDemo.fbs
```

This command will generate Java code as below

Add suitable Package import to files.

```java
// automatically generated by the FlatBuffers compiler, do not modify

package com.dkb;//You need to specify package where you are storing this java file

import java.nio.*;
import java.lang.*;
import java.util.*;
import com.google.flatbuffers.*;

@SuppressWarnings("unused")
public final class Article extends Table {
  public static Article getRootAsArticle(ByteBuffer _bb) { return getRootAsArticle(_bb, new Article()); }
  public static Article getRootAsArticle(ByteBuffer _bb, Article obj) { Constants.FLATBUFFERS_1_11_1(); _bb.order(ByteOrder.LITTLE_ENDIAN); return (obj.__assign(_bb.getInt(_bb.position()) + _bb.position(), _bb)); }
  public void __init(int _i, ByteBuffer _bb) { bb_pos = _i; bb = _bb; vtable_start = bb_pos - bb.getInt(bb_pos); vtable_size = bb.getShort(vtable_start); }
  public Article __assign(int _i, ByteBuffer _bb) { __init(_i, _bb); return this; }

  public String articleText() { int o = __offset(4); return o != 0 ? __string(o + bb_pos) : null; }
  public ByteBuffer articleTextAsByteBuffer() { return __vector_as_bytebuffer(4, 1); }
  public ByteBuffer articleTextInByteBuffer(ByteBuffer _bb) { return __vector_in_bytebuffer(_bb, 4, 1); }
  public int id() { int o = __offset(6); return o != 0 ? bb.getInt(o + bb_pos) : 0; }
  public boolean mutateId(int id) { int o = __offset(6); if (o != 0) { bb.putInt(o + bb_pos, id); return true; } else { return false; } }
  public Comment comments(int j) { return comments(new Comment(), j); }
  public Comment comments(Comment obj, int j) { int o = __offset(8); return o != 0 ? obj.__assign(__indirect(__vector(o) + j * 4), bb) : null; }
  public int commentsLength() { int o = __offset(8); return o != 0 ? __vector_len(o) : 0; }

  public static int createArticle(FlatBufferBuilder builder,
      int articleTextOffset,
      int id,
      int commentsOffset) {
    builder.startTable(3);
    Article.addComments(builder, commentsOffset);
    Article.addId(builder, id);
    Article.addArticleText(builder, articleTextOffset);
    return Article.endArticle(builder);
  }

  public static void startArticle(FlatBufferBuilder builder) { builder.startTable(3); }
  public static void addArticleText(FlatBufferBuilder builder, int articleTextOffset) { builder.addOffset(0, articleTextOffset, 0); }
  public static void addId(FlatBufferBuilder builder, int id) { builder.addInt(1, id, 0); }
  public static void addComments(FlatBufferBuilder builder, int commentsOffset) { builder.addOffset(2, commentsOffset, 0); }
  public static int createCommentsVector(FlatBufferBuilder builder, int[] data) { builder.startVector(4, data.length, 4); for (int i = data.length - 1; i >= 0; i--) builder.addOffset(data[i]); return builder.endVector(); }
  public static void startCommentsVector(FlatBufferBuilder builder, int numElems) { builder.startVector(4, numElems, 4); }
  public static int endArticle(FlatBufferBuilder builder) {
    int o = builder.endTable();
    return o;
  }
}
```

Comment.java

```java
// automatically generated by the FlatBuffers compiler, do not modify

package com.dkb;//You need to specify package where you are storing this java file

import java.nio.*;
import java.lang.*;
import java.util.*;
import com.google.flatbuffers.*;

@SuppressWarnings("unused")
public final class Comment extends Table {
  public static Comment getRootAsComment(ByteBuffer _bb) { return getRootAsComment(_bb, new Comment()); }
  public static Comment getRootAsComment(ByteBuffer _bb, Comment obj) { Constants.FLATBUFFERS_1_11_1(); _bb.order(ByteOrder.LITTLE_ENDIAN); return (obj.__assign(_bb.getInt(_bb.position()) + _bb.position(), _bb)); }
  public void __init(int _i, ByteBuffer _bb) { bb_pos = _i; bb = _bb; vtable_start = bb_pos - bb.getInt(bb_pos); vtable_size = bb.getShort(vtable_start); }
  public Comment __assign(int _i, ByteBuffer _bb) { __init(_i, _bb); return this; }

  public int id() { int o = __offset(4); return o != 0 ? bb.getInt(o + bb_pos) : 0; }
  public boolean mutateId(int id) { int o = __offset(4); if (o != 0) { bb.putInt(o + bb_pos, id); return true; } else { return false; } }
  public String commentStr() { int o = __offset(6); return o != 0 ? __string(o + bb_pos) : null; }
  public ByteBuffer commentStrAsByteBuffer() { return __vector_as_bytebuffer(6, 1); }
  public ByteBuffer commentStrInByteBuffer(ByteBuffer _bb) { return __vector_in_bytebuffer(_bb, 6, 1); }

  public static int createComment(FlatBufferBuilder builder,
      int id,
      int comment_strOffset) {
    builder.startTable(2);
    Comment.addCommentStr(builder, comment_strOffset);
    Comment.addId(builder, id);
    return Comment.endComment(builder);
  }

  public static void startComment(FlatBufferBuilder builder) { builder.startTable(2); }
  public static void addId(FlatBufferBuilder builder, int id) { builder.addInt(0, id, 0); }
  public static void addCommentStr(FlatBufferBuilder builder, int commentStrOffset) { builder.addOffset(1, commentStrOffset, 0); }
  public static int endComment(FlatBufferBuilder builder) {
    int o = builder.endTable();
    return o;
  }
}
```

[http://google.github.io/flatbuffers/flatbuffers_guide_using_schema_compiler.html](http://google.github.io/flatbuffers/flatbuffers_guide_using_schema_compiler.html)

You need to add following dependency 

```java
    implementation("com.google.flatbuffers:flatbuffers-java:1.11.1")
```



#### code

```java
import com.google.flatbuffers.FlatBufferBuilder;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.RandomAccessFile;
import java.nio.ByteBuffer;

public class FlatBuffer {
    /**
     * If you are using create Command , then be careful with it.
     * This line of code int article = Article.createArticle(fbb, articleText, 1, commentsForArticleOnFB);
     * should not be below this line of code: Article.startArticle(fbb);
     */

    // Example how to use FlatBuffers to create and read binary buffers.
    public static void main(String[] args) {
        // creating objects from the code, and serialize it

        // FlatBuffer builder needs to be used to create a FlatBuffer
        // First, initialise the FlatBuffer builder, and give it an initial size.

        FlatBufferBuilder fbb = new FlatBufferBuilder(10);

        int commentText = fbb.createString("This is my first comment to article on flatbuffer");
        Comment.startComment(fbb);
        Comment.addCommentStr(fbb, commentText);
        Comment.addId(fbb, 1);
        int comment1OnArticle1 = Comment.endComment(fbb);

        int commentText2 = fbb.createString("This is my second comment to article on flatbuffer");
        Comment.startComment(fbb);
        Comment.addCommentStr(fbb, commentText2);
        Comment.addId(fbb, 2);
        int comment2OnArticle1 = Comment.endComment(fbb);
        int commentsForArticleOnFB = fbb.createVectorOfTables(new int[]{comment1OnArticle1, comment2OnArticle1});

        int articleText = fbb.createString("My Article On Flatbuffer");
        Article.startArticle(fbb);
        Article.addId(fbb, 1);
        Article.addArticleText(fbb, articleText);
        Article.addComments(fbb, commentsForArticleOnFB);
        int article = Article.endArticle(fbb);

        fbb.finish(article);
        byte[] fbb1Bytes = fbb.sizedByteArray();

        File file = new File("articleData.art");
        try (RandomAccessFile f = new RandomAccessFile(file, "rw")) {
            f.write(fbb1Bytes);
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        }

        // get objects from file and deserialize it

        readDataFromFile("articleData.art");
        // readDataFromFile("Article.bin"); // this file we will be creating in following step
    }

    private static void readDataFromFile(String filename) {
        File file = new File(filename);
        RandomAccessFile f = null;
        try {
            f = new RandomAccessFile(file, "r");
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
        byte[] data = null;
        try {
            data = new byte[(int) f.length()];
            f.readFully(data);

        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            try {
                f.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

        ByteBuffer bb = ByteBuffer.wrap(data);
        Article article = Article.getRootAsArticle(bb);
        System.out.println("articleText : " + article.articleText());
        System.out.println("articleId : " + article.id());
        System.out.println("Total comments for article : " + article.commentsLength());
        Comment comment1 = article.comments(0);
        System.out.println("Comment1Id : " + comment1.id());
        System.out.println("Comment1 : " + comment1.commentStr());
        Comment comment2 = article.comments(1);
        System.out.println("Comment2 : " + comment2.commentStr());
        System.out.println("Comment2Id : " + comment2.id());

    }
}
/* output
articleText : My Article On Flatbuffer
articleId : 1
Total comments for article : 2
Comment1Id : 1
Comment1 : This is my first comment to article on flatbuffer
Comment2 : This is my second comment to article on flatbuffer
Comment2Id : 2

articleText : This is my first article text from binary file created using json
articleId : 5
Total comments for article : 2
Comment1Id : 1
Comment1 : This is first comment to article from binary file created using json
Comment2 : This is second comment to article from binary file created using json
Comment2Id : 2
 */
```


#### Convert Json to Binary File using Schema File

Json file

```java
{
  "id": 5,
  "articleText": "This is my first article text from binary file created using json",
  "comments" : [
    {
      "id": 1,
      "comment_str": "This is first comment to article from binary file created using json"
    },
    {
      "id": 2,
      "comment_str": "This is second comment to article from binary file created using json"
    }
  ]
}
```
Command to convert to binary file
```sh
./flatc -o <path-where-you-want-your-bin-file> -b Article.fbs Article.json
```
This will generate file with name Article.bin which will contain the FlatBuffer binary representation of the contents from our Article.json file.


#### Ref:

https://github.com/hash-X/FlatBuffer

https://en.wikipedia.org/wiki/Interface_description_language

https://medium.com/@icex33/beyond-json-introduction-to-flatbuffers-fba1dfd0dcfe

https://github.com/mzaks/FlatBuffersSwift/wiki/FlatBuffers-Explained

https://github.com/ScreamingUdder/wiki/wiki/Sending-FlatBuffers-through-Kafka-in-Java

https://github.com/google/flatbuffers/blob/master/tests/JavaTest.java

Language Level features: https://google.github.io/flatbuffers/flatbuffers_support.html


